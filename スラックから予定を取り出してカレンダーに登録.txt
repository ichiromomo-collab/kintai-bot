function notifySlack(message) {
  const token = "xoxb-9276453172948-10032330419026-WgXaKVQwhJXNJEBTxdAag3Gt"; // â† Bot Tokenã‚’è²¼ã‚Šä»˜ã‘
  const channel = "C0981JUPKRT"; // é€£çµ¡ãƒãƒ£ãƒ³ãƒãƒ«ID

  const url = "https://slack.com/api/chat.postMessage";
  const payload = {
    token: token,
    channel: channel,
    text: message
  };

  const options = {
    method: "post",
    payload: payload
  };

  const response = UrlFetchApp.fetch(url, options);
  Logger.log(response.getContentText());
}

function listCalendars() {
  const calendars = CalendarApp.getAllCalendars();
  calendars.forEach(cal => {
    Logger.log(cal.getName() + " : " + cal.getId());
  });
}

function testCalendarEvent() {
  const calendar = CalendarApp.getCalendarById("houkan.omusubi1@gmail.com");
  const title = "ãƒ†ã‚¹ãƒˆè¨ªå•äºˆå®š";
  const startTime = new Date("2025-12-03T10:00:00");
  const endTime = new Date("2025-12-03T11:00:00");

  calendar.createEvent(title, startTime, endTime);
}
function testMessageParsing() {
  parseMessageAndAddEvent("â—‹â—‹ã•ã‚“ã€æ˜Žæ—¥10æ™‚ã«è¨ªå•ã­");
  parseMessageAndAddEvent("12/5ã«é¢è«‡");
}

function parseMessageAndAddEvent(message) {
  const calendar = CalendarApp.getCalendarById("houkan.omusubi1@gmail.com");

  let title = "äºˆå®š";
  let startTime, endTime;

  // ã€Œæ˜Žæ—¥10æ™‚ã€ãƒ‘ã‚¿ãƒ¼ãƒ³
  if (message.match(/æ˜Žæ—¥.*(\d{1,2})æ™‚/)) {
    const hour = parseInt(RegExp.$1, 10);
    const today = new Date();
    today.setDate(today.getDate() + 1);
    startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, 0);
    endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour + 1, 0);
    title = "è¨ªå•äºˆå®š";
  }

  // ã€Œ12/5ã€ãƒ‘ã‚¿ãƒ¼ãƒ³
  else if (message.match(/(\d{1,2})\/(\d{1,2})/)) {
    const month = parseInt(RegExp.$1, 10) - 1;
    const day = parseInt(RegExp.$2, 10);
    const year = new Date().getFullYear();
    startTime = new Date(year, month, day, 10, 0);
    endTime = new Date(year, month, day, 11, 0);
    title = "é¢è«‡äºˆå®š";
  }

else if (message.match(/(\d{1,2})\/(\d{1,2}).*?(\d{1,2})[:ï¼š](\d{2})/)) {
  const month = parseInt(RegExp.$1, 10) - 1;
  const day = parseInt(RegExp.$2, 10);
  const hour = parseInt(RegExp.$3, 10);
  const minute = parseInt(RegExp.$4, 10);
  const year = new Date().getFullYear();
   startTime = new Date(year, month, day, hour, minute);
   endTime = new Date(year, month, day, hour + 1, minute);
  title = message.includes("å¿˜å¹´ä¼š") ? "å¿˜å¹´ä¼š" :
          message.includes("æ‹…å½“è€…ä¼šè­°") ? "æ‹…å½“è€…ä¼šè­°" :
          message.includes("æ­“è¿Žä¼š") ? "æ­“è¿Žä¼š" : "ã‚¤ãƒ™ãƒ³ãƒˆ";
}
}
const year = new Date().getFullYear();
const month = parseInt(RegExp.$1, 10) - 1;
const day = parseInt(RegExp.$2, 10);
const hour = parseInt(RegExp.$3, 10);
const minute = parseInt(RegExp.$4, 10);

const startTime = new Date(year, month, day, hour, minute);
const endTime = new Date(year, month, day, hour + 1, minute);

let title = "äºˆå®š";
if (message.includes("å¿˜å¹´ä¼š")) {
  title = "å¿˜å¹´ä¼š";
} else if (message.includes("æ‹…å½“è€…ä¼šè­°")) {
  title = "æ‹…å½“è€…ä¼šè­°";
} else if (message.includes("æ­“è¿Žä¼š")) {
  title = "æ­“è¿Žä¼š";
} else if (message.includes("æ±‚äºº")) {
  title = "æ±‚äººå¯¾å¿œ";
} else if (message.includes("è¦‹å­¦")) {
  title = "è¦‹å­¦å¯¾å¿œ";
} else if (message.includes("é¢è«‡")) {
  title = "é¢è«‡äºˆå®š";
}else if (message.includes("äºˆå®š")) {
    title = "äºˆå®š";
  }
  if (startTime && endTime) {
    calendar.createEvent(title, startTime, endTime);
  }


function fetchSlackMessages() {
  const token = "xoxb-9276453172948-10032330419026-WgXaKVQwhJXNJEBTxdAag3Gt";
  const channel = "C0981JUPKRT";
  const url = "https://slack.com/api/conversations.history";

  const options = {
    method: "get",
    headers: {
      Authorization: "Bearer " + token
    },
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(`${url}?channel=${channel}&limit=5`, options);
  const data = JSON.parse(response.getContentText());

  if (data.ok) {
    const messages = data.messages;
    messages.forEach(msg => {
      if (msg.text) {
        parseMessageAndAddEvent(msg.text);
        notifySlack(`äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸï¼š${msg.text}`);
      }
    });
  } else {
    Logger.log("Slack API error: " + data.error);
  }
}
// æ—¢å­˜ã®é–¢æ•°ãŸã¡ã®å¾Œã«â€¦

function notifyUpcomingEvents() {
  const calendar = CalendarApp.getCalendarById("houkan.omusubi1@gmail.com");
  const now = new Date();
  const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

  const events = calendar.getEvents(now, oneHourLater);
  if (events.length === 0) return;

  events.forEach(event => {
    const title = event.getTitle();
    const startTime = Utilities.formatDate(event.getStartTime(), Session.getScriptTimeZone(), "HH:mm");
    const message = `â° ã¾ã‚‚ãªãäºˆå®šã§ã™ï¼š${startTime}ã€œ ${title}`;
    notifySlack(message);
  });
}
function notifyWeeklyEvents() {
  const calendar = CalendarApp.getCalendarById("houkan.omusubi1@gmail.com");
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(start.getDate() + 7);

  const events = calendar.getEvents(start, end);
  if (events.length === 0) {
    notifySlack("ðŸ—“ ä»Šé€±ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“");
  } else {
    let message = "ðŸ—“ ä»Šé€±ã®äºˆå®šä¸€è¦§ï¼š\n";
    events.forEach(event => {
      const date = Utilities.formatDate(event.getStartTime(), Session.getScriptTimeZone(), "MM/dd(E)");
      const time = Utilities.formatDate(event.getStartTime(), Session.getScriptTimeZone(), "HH:mm");
      const title = event.getTitle();
      message += `ãƒ»${date} ${time} ${title}\n`;
    });
    notifySlack(message);
  }
}
